<div class="container fade-in">
    <div class="header-section text-center mb-5">
        <h1>Contáctanos</h1>
        <p class="text-muted">Estamos aquí para resolver tus dudas. Validamos tu información en tiempo real.</p>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-md">

                <div *ngIf="apiMessage && !enviado" class="alert alert-danger m-3">
                    {{ apiMessage }}
                </div>
                <div *ngIf="enviado" class="alert alert-success m-3">
                    ✅ {{ apiMessage || 'Mensaje enviado correctamente.' }}
                </div>

                <form #f="ngForm" (ngSubmit)="enviar(f)" novalidate class="p-4">

                    <div class="mb-4">
                        <label class="form-label">Nombre</label>
                        <input type="text" class="form-control" name="nombre" [(ngModel)]="form.nombre" required
                            minlength="3" maxlength="60" [pattern]="nombreRegex" #nombre="ngModel"
                            [class.is-invalid]="(nombre.invalid && (nombre.touched || f.submitted)) || hasApiError('nombre')"
                            [class.is-valid]="nombre.valid && (nombre.touched || f.submitted) && !hasApiError('nombre')"
                            placeholder="Ej: Juan Pérez" />

                        <div class="invalid-feedback">
                            <div *ngIf="nombre.errors?.['required']">El nombre es obligatorio.</div>
                            <div *ngIf="nombre.errors?.['minlength']">El nombre debe tener al menos 3 caracteres.</div>
                            <div *ngIf="nombre.errors?.['maxlength']">El nombre no debe superar 60 caracteres.</div>
                            <div *ngIf="nombre.errors?.['pattern']">Usa solo letras y espacios.</div>
                            <div *ngIf="hasApiError('nombre')">{{ apiError('nombre') }}</div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Correo Electrónico</label>
                        <input type="email" class="form-control" name="correo" [(ngModel)]="form.correo" required
                            maxlength="120" pattern="^[^\s@]+@[^\s@]+\.[^\s@]{2,}$" #correo="ngModel"
                            [class.is-invalid]="(correo.invalid && (correo.touched || f.submitted)) || hasApiError('correo')"
                            [class.is-valid]="correo.valid && (correo.touched || f.submitted) && !hasApiError('correo')"
                            placeholder="ejemplo@correo.com" />

                        <div class="invalid-feedback">
                            <div *ngIf="correo.errors?.['required']">El correo es obligatorio.</div>
                            <div *ngIf="correo.errors?.['email']">El formato del correo no es válido.</div>
                            <div *ngIf="correo.errors?.['pattern']">El correo debe incluir dominio válido.</div>
                            <div *ngIf="hasApiError('correo')">{{ apiError('correo') }}</div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Confirmar Correo</label>
                        <input type="email" class="form-control" name="confirmarCorreo"
                            [(ngModel)]="form.confirmarCorreo" required maxlength="120"
                            pattern="^[^\s@]+@[^\s@]+\.[^\s@]{2,}$" #confirmarCorreo="ngModel"
                            [class.is-invalid]="(confirmarCorreo.invalid && (confirmarCorreo.touched || f.submitted)) || (confirmarCorreo.valid && (confirmarCorreo.touched || f.submitted) && !correosCoinciden()) || hasApiError('confirmarCorreo')"
                            [class.is-valid]="confirmarCorreo.valid && (confirmarCorreo.touched || f.submitted) && correosCoinciden() && !hasApiError('confirmarCorreo')"
                            placeholder="Repite tu correo" />

                        <div class="invalid-feedback">
                            <div *ngIf="confirmarCorreo.errors?.['required']">Confirma tu correo.</div>
                            <div *ngIf="!confirmarCorreo.errors && !correosCoinciden()">El correo no coincide.</div>
                            <div *ngIf="hasApiError('confirmarCorreo')">{{ apiError('confirmarCorreo') }}</div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Mensaje</label>
                        <textarea class="form-control" name="mensaje" [(ngModel)]="form.mensaje" required minlength="10"
                            maxlength="500" #mensaje="ngModel"
                            [class.is-invalid]="(mensaje.invalid && (mensaje.touched || f.submitted)) || hasApiError('mensaje')"
                            [class.is-valid]="mensaje.valid && (mensaje.touched || f.submitted) && !hasApiError('mensaje')"
                            rows="5" placeholder="¿En qué podemos ayudarte?"></textarea>

                        <div class="d-flex justify-content-end mt-1">
                            <small class="text-muted">{{ form.mensaje.length }}/500</small>
                        </div>

                        <div class="invalid-feedback">
                            <div *ngIf="mensaje.errors?.['required']">El mensaje es obligatorio.</div>
                            <div *ngIf="mensaje.errors?.['minlength']">Mínimo 10 caracteres.</div>
                            <div *ngIf="hasApiError('mensaje')">{{ apiError('mensaje') }}</div>
                        </div>
                    </div>

                    <div class="mb-4 p-3 bg-light rounded">
                        <label class="form-label d-block text-center fw-bold">Verificación: {{ desafioActual }}</label>
                        <input type="text" class="form-control text-center" name="respuesta"
                            [(ngModel)]="form.respuesta" required #respuesta="ngModel"
                            [class.is-invalid]="(respuesta.invalid && (respuesta.touched || f.submitted)) || (respuesta.valid && (respuesta.touched || f.submitted) && !desafioValido()) || hasApiError('respuesta')"
                            placeholder="Escribe el resultado" style="max-width: 200px; margin: 0 auto;" />

                        <div class="invalid-feedback text-center">
                            <div *ngIf="!respuesta.errors && !desafioValido()">Respuesta incorrecta.</div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-secondary me-md-2" (click)="limpiar(f)"
                            [disabled]="loading">
                            Limpiar
                        </button>
                        <button type="submit" class="btn"
                            [disabled]="loading || f.invalid || !correosCoinciden() || !desafioValido()">
                            {{ loading ? 'Enviando...' : 'Enviar Mensaje' }}
                        </button>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>